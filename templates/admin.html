<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Remote Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1>Admin Panel</h1>
    <p class="text-muted">Send commands to connected devices</p>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Send Command</h5>
        <form id="commandForm">
          <div class="mb-3">
            <label for="command" class="form-label">Command</label>
            <select class="form-select" id="command" required>
              <option value="">Select a command...</option>
              <option value="ping">Ping</option>
              <option value="collect_info">Collect Info</option>
              <option value="show_alert">Show Alert</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="room" class="form-label">Target Room</label>
            <input type="text" class="form-control" id="room" value="all" required>
            <div class="form-text">Use 'all' to broadcast to all devices</div>
          </div>
          <div class="mb-3">
            <label for="payload" class="form-label">Payload (JSON)</label>
            <textarea class="form-control" id="payload" rows="3" placeholder="{}">{}</textarea>
          </div>
          <button type="submit" class="btn btn-primary">Send Command</button>
        </form>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Command Results</h5>
        <div id="results" class="mt-3"></div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Audit Log</h5>
        <button class="btn btn-secondary btn-sm" id="loadAudit">Load Audit</button>
        <div id="auditLog" class="mt-3 small"></div>
      </div>
    </div>
  </div>

<script>
const socket = io();

socket.on('connect', () => {
  appendResult('Admin connected to server');
});

socket.on('command', (data) => {
  appendResult('Command issued: ' + JSON.stringify(data));
});

document.getElementById('commandForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const command = document.getElementById('command').value;
  const room = document.getElementById('room').value;
  let payload = {};
  
  try {
    const payloadText = document.getElementById('payload').value.trim();
    if (payloadText) {
      payload = JSON.parse(payloadText);
    }
  } catch(err) {
    alert('Invalid JSON in payload: ' + err.message);
    return;
  }

  try {
    const response = await fetch('/send_command', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({command, room, payload})
    });
    
    const result = await response.json();
    
    if (response.ok) {
      appendResult('SUCCESS: ' + JSON.stringify(result, null, 2), 'success');
    } else {
      appendResult('ERROR: ' + JSON.stringify(result, null, 2), 'danger');
    }
  } catch(err) {
    appendResult('Request failed: ' + err.message, 'danger');
  }
});

document.getElementById('loadAudit').addEventListener('click', async () => {
  try {
    const response = await fetch('/audit');
    const audit = await response.json();
    const auditLog = document.getElementById('auditLog');
    auditLog.innerHTML = '';
    
    if (audit.length === 0) {
      auditLog.innerHTML = '<div class="text-muted">No audit entries yet</div>';
      return;
    }
    
    audit.reverse().forEach(entry => {
      const div = document.createElement('div');
      div.className = 'border-bottom pb-2 mb-2';
      div.innerHTML = '<pre class="mb-0">' + JSON.stringify(entry, null, 2) + '</pre>';
      auditLog.appendChild(div);
    });
  } catch(err) {
    alert('Failed to load audit: ' + err.message);
  }
});

function appendResult(text, type = 'info') {
  const d = document.createElement('div');
  d.className = 'alert alert-' + type + ' alert-dismissible fade show';
  d.innerHTML = '<small>[' + new Date().toLocaleTimeString() + ']</small> ' + 
                '<pre class="mb-0 d-inline">' + text + '</pre>' +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
  document.getElementById('results').prepend(d);
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
